#!/usr/bin/env bash

docker exec -i --user postgres writegood_db_1 createdb writegooddb

docker exec -i --user postgres writegood_db_1 psql writegooddb -a <<EOF
create user writegood_role password 'lacinia';
EOF

docker exec -i writegood_db_1 psql -Uwritegood_role writegooddb -a <<EOF
drop table if exists users;
drop table if exists documents;
EOF

create or replace function maintain_updated_at()
returns trigger as \$\$
begin
        new.updated_at = now();
        return new;
end;
\$\$ language 'plpgsql';

create table users (
       id int generated by default as identity primary key,
       email text not null,
       created_at timestamp not null default current_timestamp,
       updated_at timestamp not null default current_timestamp
);

create trigger users_updated_at before update on users for each row execute procedure maintain_updated_at();

create table documents (
       id int generated by default as identity primary key,
       text text not null,
       author_id int references users(id),
       created_at timestamp not null default current_timestamp,
       updated_at timestamp not null default current_timestamp
);

create trigger documents_updated_at before update on documents for each row execute procedure maintain_updated_at();

insert into users (id, email) values
(1, "tj@example.com"),
(2, "callie@example.com");

insert into documents (id, author_id, text) values
(1, 1, "TJ's note."),
(2, 2, "Callie's note."),

EOF
